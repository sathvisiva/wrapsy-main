{"version":3,"sources":["../../../../server/api/payment/payment.controller.js"],"names":[],"mappings":";;;;;;;;;AASC,YAAY,CAAC;;;;;;;;;;;;;;;;;;sBAEC,QAAQ;;;;AACtB,IAAI,OAAO,GAAG,OAAO,CAAC,iBAAiB,CAAC,CAAC;AACzC,IAAI,MAAM,GAAG,OAAO,CAAC,WAAW,CAAC,CAAC;AAClC,IAAI,EAAE,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;AAChC,IAAI,OAAO,GAAG,OAAO,CAAC,0BAA0B,CAAC,CAAC;;AAElD,IAAI,KAAK,GAAG,OAAO,CAAC,sBAAsB,CAAC,CAAC;AAC5C,IAAI,IAAI,GAAG,OAAO,CAAC,kBAAkB,CAAC,CAAC;AACvC,IAAI,QAAQ,GAAG,OAAO,CAAC,4BAA4B,CAAC,CAAC,QAAQ,CAAC;AAC9D,IAAI,YAAY,GAAG,OAAO,CAAC,4BAA4B,CAAC,CAAC,YAAY,CAAA;AACrE,IAAI,kBAAkB,GAAG,OAAO,CAAC,iCAAiC,CAAC,CAAC;;AAEpE,SAAS,WAAW,CAAC,GAAG,EAAE,UAAU,EAAE;AACrC,YAAU,GAAG,UAAU,IAAI,GAAG,CAAC;AAC/B,SAAO,UAAS,GAAG,EAAE;AACnB,OAAG,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;GAClC,CAAC;CACH;;AAED,SAAS,kBAAkB,CAAC,GAAG,EAAE,UAAU,EAAE;AAC3C,YAAU,GAAG,UAAU,IAAI,GAAG,CAAC;AAC/B,SAAO,UAAS,MAAM,EAAE;AACtB,QAAI,MAAM,EAAE;AACV,SAAG,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;KACrC;GACF,CAAC;CACH;;AAED,SAAS,oBAAoB,CAAC,GAAG,EAAE;AACjC,SAAO,UAAS,MAAM,EAAE;AACtB,QAAI,CAAC,MAAM,EAAE;AACX,SAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,CAAC;AACtB,aAAO,IAAI,CAAC;KACb;AACD,WAAO,MAAM,CAAC;GACf,CAAC;CACH;;AAGD,SAAS,aAAa,CAAC,GAAG,EAAC,WAAW,EAAC;;AAErC,SAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AACjB,SAAO,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;CAI1B;;AAED,SAAS,WAAW,CAAC,OAAO,EAAE;AAC5B,SAAO,UAAS,MAAM,EAAE;AACtB,QAAI,OAAO,GAAG,oBAAE,KAAK,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;AACvC,WAAO,OAAO,CAAC,SAAS,EAAE,CACzB,MAAM,CAAC,UAAA,OAAO,EAAI;AACjB,aAAO,OAAO,CAAC;KAChB,CAAC,CAAC;GACJ,CAAC;CACH;;AAED,SAAS,YAAY,CAAC,GAAG,EAAE;AACzB,SAAO,UAAS,MAAM,EAAE;AACtB,QAAI,MAAM,EAAE;AACV,aAAO,MAAM,CAAC,WAAW,EAAE,CAC1B,IAAI,CAAC,YAAM;AACV,WAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,CAAC;OACvB,CAAC,CAAC;KACJ;GACF,CAAC;CACH;;AAEM,SAAS,UAAU,CAAC,GAAG,EAAE,GAAG,EAAE;AACnC,SAAO,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;AAClC,MAAI,IAAI,GAAG,UAAU,CAAC;AACtB,MAAI,IAAI,GAAG,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,CAAC;AACjD,SAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AAClB,KAAG,CAAC,IAAI,CAAC,EAAC,OAAO,EAAG,IAAI,EAAE,IAAI,EAAE,IAAI,EAAC,CAAC,CAAC;CACxC;;AAEM,SAAS,wBAAwB,CAAC,GAAG,EAAE,GAAG,EAAE;;AAGjD,SAAO,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,UAAS,GAAG,EAAE,OAAO,EAAC;AAC7C,QAAG,GAAG,EAAC;AACL,iBAAW,CAAC,OAAO,CAAC,CAAA;KACrB;;AAED,WAAO,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,IAAI,EAAE,IAAI,EAAG,SAAS,EAAE,OAAO,CAAC,GAAG,EAAE,EAAC,EAAE,UAAU,GAAG,EAAE,OAAO,EAAE;AACtH,UAAI,GAAG,EAAE;AACP,mBAAW,CAAC,GAAG,CAAC,CAAA;OACjB;;AAED,aAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE,UAAU,GAAG,EAAE,OAAO,EAAE;;AAE7D,YAAG,GAAG,EAAE;AAAE,iBAAO,WAAW,CAAC,GAAG,CAAC,CAAC;SAAE;AACpC,YAAI,cAAc,GAAG,CACrB;AACE,iBAAO,EAAE,OAAO,CAAC,KAAK;AACtB,kBAAQ,EAAE,OAAO,CAAC,MAAM;AACxB,uBAAa,EAAE,OAAO,CAAC,IAAI;SAC5B,CACA,CAAC;;AAEF,eAAO,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;AAC5B,YAAI,CAAC,QAAQ,CAAC,SAAS,EAAC,cAAc,CAAC,CAAC;OAEzC,CAAC,CAAC;;AAIH,SAAG,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAC;KAC7B,CAAC,CAAC;GACJ,CAAC,CAAC;CAQJ;;AAEM,SAAS,uBAAuB,CAAC,GAAG,EAAE,GAAG,EAAC;;AAG/C,SAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AACjB,SAAO,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;;AAEtB,SAAO,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,IAAI,EAAE,KAAK,EAAE,EAAC,EAAE,UAAU,GAAG,EAAE,OAAO,EAAE;AAC9F,QAAI,GAAG,EAAE;AACP,oBAAc,CAAC,GAAG,GAAG,GAAG,CAAC;AACzB,oBAAc,CAAC,IAAI,GAAG,IAAI,CAAC;AAC3B,oBAAc,CAAC,IAAI,GAAG,GAAG,CAAC;;AAE1B,aAAO,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;KACjC;;AAED,OAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;GACvB,CAAC,CAAC;CAEJ;;AAGM,SAAS,gBAAgB,CAAC,GAAG,EAAE,GAAG,EAAE;AACzC,OAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,EAAC,EAAE,UAAU,GAAG,EAAE,OAAO,EAAE;AAC3F,QAAI,GAAG,EAAE;AACP,oBAAc,CAAC,GAAG,GAAG,GAAG,CAAC;AACzB,oBAAc,CAAC,IAAI,GAAG,IAAI,CAAC;AAC3B,oBAAc,CAAC,IAAI,GAAG,GAAG,CAAC;;AAE1B,aAAO,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;KACjC;;AAED,OAAG,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;GACzB,CAAC,CAAC;CACJ;;AAEM,SAAS,kBAAkB,CAAC,GAAG,EAAE,GAAG,EAAE;AAC3C,SAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC;AAC/B,SAAO,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AACtB,SAAO,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;AAClD,MAAI,GAAG,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;AAC/C,MAAI,WAAW,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;AACjC,MAAI,YAAY,GAAG,EAAE,CAAA;AACrB,cAAY,CAAC,SAAS,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;AACjD,cAAY,CAAC,YAAY,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC;AAC3C,cAAY,CAAC,UAAU,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC;AACzC,cAAY,CAAC,IAAI,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC;AACnC,cAAY,CAAC,MAAM,CAAC,YAAY,EAAE,UAAS,GAAG,EAAE,QAAQ,EAAE;AACxD,QAAG,GAAG,EAAE;AAAE,aAAO,WAAW,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;KAAE;GAE1C,CAAC,CAAC;;AAEH,SAAO,CAAC,GAAG,CAAC,YAAY,CAAC,YAAY,CAAC,CAAC;AACvC,SAAO,CAAC,GAAG,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC;AACrC,SAAO,CAAC,GAAG,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;;AAEpC,MAAI,SAAS,GAAG;AACd,QAAI,EAAE;AACJ,uBAAiB,EAAE,QAAQ,CAAC,YAAY,CAAC,YAAY,CAAC;KACvD;GACF,CAAC;AACF,MAAI,KAAK,GAAG;AACV,SAAK,EAAE,YAAY,CAAC,UAAU,CAAC,QAAQ,EAAE;AACzC,kBAAc,EAAE,YAAY,CAAC,SAAS,CAAC,QAAQ,EAAE;;GAElD,CAAC;;AAEF,UAAQ,CAAC,MAAM,CAAC,KAAK,EAAE,SAAS,EAAE,UAAS,GAAG,EAAC,QAAQ,EAAC;AACtD,WAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;GACvB,CAAC,CAAC;CAAC;;;;AAGG,SAAS,KAAK,CAAC,GAAG,EAAE,GAAG,EAAE;AAC9B,SAAO,CAAC,SAAS,EAAE,CAClB,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC,SACxB,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC;CAC1B;;;;AAGM,SAAS,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE;AAC7B,SAAO,CAAC,aAAa,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,CACnC,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,CAAC,CAC/B,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC,SACxB,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC;CAC1B;;;;AAGM,SAAS,MAAM,CAAC,GAAG,EAAE,GAAG,EAAE;;AAG/B,KAAG,CAAC,IAAI,CAAC,IAAI,GAAG,EAAE,CAAC,QAAQ,EAAE,CAAC,CAAC;AAC/B,SAAO,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;;AAEtB,SAAO,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,CAC5B,IAAI,CAAC,kBAAkB,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,SAC7B,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC;CAC1B;;;;AAGM,SAAS,MAAM,CAAC,GAAG,EAAE,GAAG,EAAE;AAC/B,MAAI,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE;AAChB,WAAO,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC;GACrB;AACD,SAAO,CAAC,aAAa,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,CACnC,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,CAAC,CAC/B,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAC3B,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC,SACxB,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC;CAC1B;;;;AAGM,SAAS,OAAO,CAAC,GAAG,EAAE,GAAG,EAAE;AAChC,SAAO,CAAC,aAAa,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,CACnC,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,CAAC,CAC/B,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,CAAC,SAClB,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC;CAC1B","file":"payment.controller.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * GET     /api/Vouchers              ->  index\n * POST    /api/Vouchers              ->  create\n * GET     /api/Vouchers/:id          ->  show\n * PUT     /api/Vouchers/:id          ->  update\n * DELETE  /api/Vouchers/:id          ->  destroy\n */\n\n 'use strict';\n\n import _ from 'lodash';\n var Payment = require('./payment.model');\n var sha512 = require('js-sha512');\n var cc = require('coupon-code');\n var Voucher = require('../voucher/voucher.model');\n\n var Order = require('../order/order.model');\n var mail = require('../mail/sendmail');\n var Registry = require('../registry/registry.model').registry;\n var Contribution = require('../registry/registry.model').contribution\n var Registrycontroller = require('../registry/registry.controller');\n\n function handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nfunction responseWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\n\nfunction handleEntityNotFound(res) {\n  return function(entity) {\n    if (!entity) {\n      res.status(404).end();\n      return null;\n    }\n    return entity;\n  };\n}\n\n\nfunction updateVoucher(res,productinfo){\n\n  console.log(res);\n  console.log(productinfo);\n\n\n\n}\n\nfunction saveUpdates(updates) {\n  return function(entity) {\n    var updated = _.merge(entity, updates);\n    return updated.saveAsync()\n    .spread(updated => {\n      return updated;\n    });\n  };\n}\n\nfunction removeEntity(res) {\n  return function(entity) {\n    if (entity) {\n      return entity.removeAsync()\n      .then(() => {\n        res.status(204).end();\n      });\n    }\n  };\n}\n\nexport function createHash(req, res) {\n  console.log(\"inside create hash\");\n  var salt = 'eCwWELxi';\n  var hash = sha512(req.body.preHashString + salt);\n  console.log(hash);\n  res.send({success : true, hash: hash});\n}\n\nexport function giftSuccessPaymentStatus(req, res) {\n\n\n  Payment.create(req.body, function(err, payment){\n    if(err){\n      handleError(payment)\n    }\n\n    Voucher.update({ _id: req.body.productinfo }, { $set: { paid: true,  paymentId: payment._id }}, function (err, voucher) {\n      if (err) {\n        handleError(err)\n      }\n\n      Voucher.findById(req.body.productinfo, function (err, voucher) {\n\n        if(err) { return handleError(err); }\n        let voucherdetails = [\n        {\n          'email': voucher.email,\n          'amount': voucher.amount,\n          'vouchercode': voucher.code,\n        }\n        ];\n\n        console.log(voucherdetails);\n        mail.sendmail('voucher',voucherdetails);\n\n      });\n\n\n\n      res.redirect('/myvouchers');\n    });\n  });\n\n\n  \n  \n\n\n  \n}\n\nexport function giftFilurePaymentStatus(req, res){\n\n\n  console.log(req);\n  console.log(req.body);\n\n  Voucher.update({ _id: req.body.productinfo }, { $set: { paid: false }}, function (err, voucher) {\n    if (err) {\n      responseObject.err = err;\n      responseObject.data = null;\n      responseObject.code = 422;\n\n      return res.json(responseObject);\n    }\n\n    res.redirect('/cart');\n  });\n\n}\n\n\nexport function pdtPaymentStatus(req, res) {\n  Order.update({ _id: req.body.productinfo }, { $set: { paid: true }}, function (err, voucher) {\n    if (err) {\n      responseObject.err = err;\n      responseObject.data = null;\n      responseObject.code = 422;\n\n      return res.json(responseObject);\n    }   \n\n    res.redirect('/orders');\n  });\n}\n\nexport function contributionStatus(req, res) {\n  console.log('payment success');\n  console.log(req.body);\n  console.log(JSON.stringify(req.body.productinfo));\n  var str = JSON.stringify(req.body.productinfo);\n  var productInfo = str.split(\" \");\n  var contribution = {}\n  contribution.productId = productInfo[0].slice(1);\n  contribution.contribution = productInfo[1];\n  contribution.registryId = productInfo[2];\n  contribution.name = productInfo[3];\n  Contribution.create(contribution, function(err, registry) {\n    if(err) { return handleError(res, err); }\n    \n  });\n\n  console.log(contribution.contribution);\n  console.log(contribution.registryId);\n  console.log(contribution.productId);\n\n  var increment = {\n    $inc: {\n      'products.$.paid': parseInt(contribution.contribution)\n    }\n  };\n  var query = {\n    '_id': contribution.registryId.toString(),\n    'products._id': contribution.productId.toString()\n\n  };\n\n  Registry.update(query, increment, function(err,registry){\n    console.log(registry);\n  });}\n\n  // Gets a list of Vouchers\n  export function index(req, res) {\n    Voucher.findAsync()\n    .then(responseWithResult(res))\n    .catch(handleError(res));\n  }\n\n  // Gets a single Voucher from the DB\n  export function show(req, res) {\n    Voucher.findByIdAsync(req.params.id)\n    .then(handleEntityNotFound(res))\n    .then(responseWithResult(res))\n    .catch(handleError(res));\n  }\n\n  // Creates a new Voucher in the DB\n  export function create(req, res) {\n\n\n    req.body.code = cc.generate();;\n    console.log(req.body);\n\n    Voucher.createAsync(req.body)\n    .then(responseWithResult(res, 201))\n    .catch(handleError(res));\n  }\n\n  // Updates an existing Voucher in the DB\n  export function update(req, res) {\n    if (req.body._id) {\n      delete req.body._id;\n    }\n    Voucher.findByIdAsync(req.params.id)\n    .then(handleEntityNotFound(res))\n    .then(saveUpdates(req.body))\n    .then(responseWithResult(res))\n    .catch(handleError(res));\n  }\n\n  // Deletes a Voucher from the DB\n  export function destroy(req, res) {\n    Voucher.findByIdAsync(req.params.id)\n    .then(handleEntityNotFound(res))\n    .then(removeEntity(res))\n    .catch(handleError(res));\n  }\n"]}