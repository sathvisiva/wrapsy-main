{"version":3,"sources":["../../../../server/api/user/user.controller.js"],"names":[],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport User from './user.model';\nimport passport from 'passport';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\nvar async = require('async');\nvar crypto = require('crypto');\nvar mail = require('../mail/sendmail');\n\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    res.status(statusCode).json(err);\n  }\n}\n\nfunction isJson(str) {\n  try {\n    str = JSON.parse(str);\n  } catch (e) {\n    str = str;\n  }\n  return str\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nfunction respondWith(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function() {\n    res.status(statusCode).end();\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\n export function index(req, res, next) {\n  if(req.query){\n    var q = isJson(req.query.where);\n    User.find(q).exec(function (err, user) {\n      if(err) { console.log(err);\n        return handleError(res, err); }\n\n        return res.status(200).json(user);\n      });\n  }else{\n    User.findAsync({}, '-salt -password')\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n  }\n}\n\n/**\n * Creates a new user\n */\n export function create(req, res, next) {\n  var newUser = new User(req.body);\n  newUser.provider = 'local';\n  newUser.role = 'user';\n  newUser.saveAsync()\n  .spread(function(user) {\n    var token = jwt.sign({\n      _id: user._id\n    }, config.secrets.session, {\n      expiresIn: 60 * 60 * 5\n    });\n    res.json({\n      token\n    });\n  })\n  .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\n export function show(req, res, next) {\n  var userId = req.params.id;\n\n  User.findByIdAsync(userId)\n  .then(user => {\n    if (!user) {\n      return res.status(404).end();\n    }\n    res.json(user.profile);\n  })\n  .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\n export function destroy(req, res) {\n  User.findByIdAndRemoveAsync(req.params.id)\n  .then(function() {\n    res.status(204).end();\n  })\n  .catch(handleError(res));\n}\n\n\n\nexport function changePassword(req, res, next) {\n\n  var userId = req.params.id;\n\n  var newPass = String(req.body.newPassword);\n\n  User.findOne({email: userId})\n  .then(user => {\n   user.password = req.body.newPassword;\n   user.resetPasswordToken = undefined;\n   user.resetPasswordExpires = undefined;\n   user.save(function(err) {\n    if(err){\n      console.log(err)\n    }\n    res.status(204).end();\n\n  });\n\n\n });\n}\n\n/**\n * Get my info\n */\n export function me(req, res, next) {\n  var userId = req.user._id;\n\n  User.findOneAsync({\n    _id: userId\n  }, '-salt -password')\n    .then(user => { // don't ever give out the password or salt\n      if (!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(err => next(err));\n  }\n\n/**\n * Authentication callback\n */\n export function authCallback(req, res, next) {\n  res.redirect('/');\n}\n\n/**\n * Add category authorization\n */\n export function authorize(req, res, next) {\n  var userId = req.params._id,\n  categoryId = req.body.categoryId;\n\n  User.findByIdAsync(userId)\n  .then(user => {\n    user.categories.push(categoryId);\n    return user.saveAsync()\n    .then(() => {\n      res.status(204).end();\n    })\n    .catch(validationError(res));\n  });\n}\n\n/**\n * Remove category authorization\n */\n export function deAuthorize(req, res, next) {\n  var userId = req.params._id,\n  categoryId = req.params.cat_id;\n\n  User.findByIdAsync(userId)\n  .then(user => {\n    user.categories.splice(user.categories.indexOf(categoryId), 1);\n    return user.saveAsync()\n    .then(() => {\n      res.status(204).end();\n    })\n    .catch(validationError(res));\n  });\n}\n\nexport function getresetuser(req, res, next) {\n  var userId = req.params._id;\n  \n\n  User.findOne({ resetPasswordToken: req.params.token, resetPasswordExpires: { $gt: Date.now() } }, function(err, user) {\n    if (!user) {\n      req.flash('error', 'Password reset token is invalid or has expired.');\n      return res.redirect('/forgot');\n    }\n    res.render('reset', {\n      user: req.user\n    });\n  });\n\n}\n\nexports.count = function(req, res) {\n  \n  if(req.query){\n    var q = isJson(req.query.where);\n    User.find(q).count().exec(function (err, count) {\n      if(err) { \n        console.log(err)\n        return handleError(res, err); }\n        return res.status(200).json([{count:count}]);\n      });\n  }else{\n      User.count().exec(function (err, count) {\n      if(err) { \n        console.log(err)\n        return handleError(res, err); }\n        return res.status(200).json([{count:count}]);\n      });\n  }\n};\n\n\nexport function forgot(req, res, next) {\n  var emailid = String(req.body.id);\n  \n  async.waterfall([\n    function(done) {\n      crypto.randomBytes(20, function(err, buf) {\n        var token = buf.toString('hex');\n        done(err, token);\n      });\n    },\n    function(token, done) {\n      User.findOne({ email: emailid }, function(err, user) {\n        if (!user) {\n          return res.status(422).json(\"Invalid email\");\n        }\n        if(user.provider != 'local'){\n          return res.status(422).json(\"Email Registered with Social authentication\");\n        }\n        user.resetPasswordToken = token;\n              user.resetPasswordExpires = Date.now() + 3600000; // 1 hour\n              user.save(function(err) {\n                done(err, token, user);\n              });\n            });\n    },\n    function(token, user, done) {\n     let users = [\n     {\n      'host': req.headers.host,\n      'token' : token,\n      'email': user.email,\n    }\n    ];\n    mail.sendmail('forgot',users);\n    return res.status(200).json(\"success\");\n\n  }\n  ],function(err) {\n    validationError(res)\n  });\n}\n"]}